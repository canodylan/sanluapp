<div class="dashboard-shell" [class.is-mobile]="isMobile$ | async" [class.mobile-menu-open]="mobileMenuOpen">
  <header class="shell-header">
    <button
      type="button"
      class="mobile-menu-btn"
      mat-icon-button
      (click)="toggleMobileMenu()"
      *ngIf="isMobile$ | async"
      [attr.aria-label]="mobileMenuOpen ? 'Cerrar menú' : 'Abrir menú'">
      <mat-icon>{{ mobileMenuOpen ? 'close' : 'menu' }}</mat-icon>
    </button>

    <a class="logo" routerLink="/main">SANLUAPP</a>
    <div class="header-actions" [class.compact]="isMobile$ | async">
      <button mat-icon-button class="theme-btn" (click)="toggleTheme()" [attr.aria-label]="isDarkTheme ? 'Cambiar a tema claro' : 'Cambiar a tema oscuro'">
        <mat-icon>{{ isDarkTheme ? 'light_mode' : 'dark_mode' }}</mat-icon>
      </button>
      <div class="user-menu" *ngIf="!(isMobile$ | async)" (click)="$event.stopPropagation()">
        <button type="button"
                class="user-trigger"
                (click)="toggleUserMenu($event)"
                [attr.aria-label]="userMenuOpen ? 'Cerrar menú de usuario' : 'Abrir menú de usuario'"
                [attr.aria-expanded]="userMenuOpen">
          <span class="avatar">{{ userInitials }}</span>
          <mat-icon class="chevron" [class.open]="userMenuOpen">expand_more</mat-icon>
        </button>
        <div class="user-dropdown" *ngIf="userMenuOpen">
          <div class="user-dropdown-header">
            <span class="user-name">{{ user?.nickname || user?.username || 'Usuario' }}</span>
          </div>
          <button type="button"
                  class="user-dropdown-item"
                  (click)="navigateTo('/admin')"
                  *ngIf="hasAdminAccess">
            Panel de administración
          </button>
          <button type="button"
                  class="user-dropdown-item"
                  (click)="navigateTo('/settings')">
            Ajustes
          </button>
          <button type="button"
                  class="user-dropdown-item logout"
                  (click)="onLogoutFromMenu()"
                  [disabled]="isLoggingOut">
            {{ isLoggingOut ? 'Saliendo...' : 'Cerrar sesión' }}
          </button>
        </div>
      </div>
      <button
        mat-stroked-button
        color="accent"
        class="mobile-logout"
        *ngIf="isMobile$ | async"
        (click)="logout()"
        [disabled]="isLoggingOut">
        {{ isLoggingOut ? 'Saliendo...' : 'Salir' }}
      </button>
    </div>
  </header>

  <div class="mobile-nav-backdrop" *ngIf="mobileMenuOpen" (click)="toggleMobileMenu()"></div>

  <div class="shell-body">
    <nav class="shell-sidebar" *ngIf="!(isMobile$ | async)" aria-label="Navegación principal">
      <div class="nav-title">Menú</div>
      <a *ngFor="let link of navLinks; trackBy: trackByLink"
         class="nav-link"
         [routerLink]="link.route"
         routerLinkActive="active"
         [routerLinkActiveOptions]="{ exact: true }">
        {{ link.label }}
      </a>
    </nav>

    <nav class="mobile-nav-drawer" *ngIf="isMobile$ | async" aria-label="Navegación principal" [class.open]="mobileMenuOpen">
      <div class="mobile-nav-header">
        <div class="avatar">{{ userInitials }}</div>
        <div class="user-info">
          <span class="user-name">{{ user?.nickname || user?.username || 'Usuario' }}</span>
          <button mat-stroked-button color="accent" (click)="logout()" [disabled]="isLoggingOut">
            {{ isLoggingOut ? 'Saliendo...' : 'Salir' }}
          </button>
        </div>
      </div>
      <div class="nav-title">Menú</div>
      <a *ngFor="let link of navLinks; trackBy: trackByLink"
         class="nav-link"
         [routerLink]="link.route"
         routerLinkActive="active"
         [routerLinkActiveOptions]="{ exact: true }"
         (click)="handleNavSelection()">
        {{ link.label }}
      </a>
    </nav>

    <main class="shell-content">
      <router-outlet></router-outlet>
    </main>
  </div>
</div>
