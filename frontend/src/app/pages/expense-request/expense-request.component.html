<section class="expense-request">
  <mat-card class="intro-card">
    <mat-card-header>
      <mat-card-title>Registrar un gasto</mat-card-title>
      <mat-card-subtitle>Comparte la información esencial para que el equipo financiero pueda aprobarlo.</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <p class="intro-text">
        Completa el formulario con el detalle del gasto y adjunta un enlace al comprobante si lo tienes. Cuando lo envíes,
        quedará pendiente hasta que un administrador lo revise.
      </p>
      <ul class="guidelines">
        <li>
          <mat-icon>description</mat-icon>
          Describe claramente el motivo del gasto.
        </li>
        <li>
          <mat-icon>euro</mat-icon>
          Indica el importe estimado usando decimales si es necesario.
        </li>
        <li>
          <mat-icon>link</mat-icon>
          Añade un enlace al comprobante (Drive, Dropbox, etc.) cuando esté disponible.
        </li>
      </ul>
    </mat-card-content>
  </mat-card>

  <mat-card class="form-card">
    <mat-card-header>
      <mat-card-title>Formulario de solicitud</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="feedback success" *ngIf="successMessage() as success">
        <mat-icon>check_circle</mat-icon>
        <span>{{ success }}</span>
      </div>
      <div class="feedback error" *ngIf="errorMessage() as error">
        <mat-icon>error</mat-icon>
        <span>{{ error }}</span>
      </div>

      <form [formGroup]="requestForm" (ngSubmit)="submit()" novalidate>
        <mat-form-field appearance="fill">
          <mat-label>Descripción del gasto</mat-label>
          <textarea
            matInput
            rows="3"
            formControlName="description"
            placeholder="Ej: Compra de material para evento del sábado"
          ></textarea>
          <mat-hint align="end">{{ requestForm.controls.description.value?.length || 0 }}/255</mat-hint>
          <mat-error *ngIf="requestForm.controls.description.hasError('required')">
            La descripción es obligatoria.
          </mat-error>
          <mat-error *ngIf="requestForm.controls.description.hasError('maxlength')">
            Máximo 255 caracteres.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Monto estimado</mat-label>
          <input
            matInput
            type="number"
            min="0"
            step="0.01"
            formControlName="amount"
            placeholder="0,00"
          />
          <span matSuffix>€</span>
          <mat-error *ngIf="requestForm.controls.amount.hasError('required')">
            Indica el monto a reembolsar.
          </mat-error>
          <mat-error *ngIf="requestForm.controls.amount.hasError('min')">
            El monto debe ser mayor que cero.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Categoría</mat-label>
          <mat-select formControlName="categoryId" [disabled]="loadingOptions()">
            <mat-option [value]="null">Sin categoría</mat-option>
            <mat-option *ngFor="let category of categories()" [value]="category.id">
              <span class="color-dot" [style.background-color]="category.color || '#90a4ae'"></span>
              {{ category.name }}
            </mat-option>
          </mat-select>
          <mat-hint>Ayuda al equipo indicando a qué rubro pertenece.</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Cuenta a imputar (opcional)</mat-label>
          <mat-select formControlName="accountId" [disabled]="loadingOptions()">
            <mat-option [value]="null">El equipo financiero decidirá</mat-option>
            <mat-option *ngFor="let account of accounts()" [value]="account.id">
              {{ account.name }} · {{ account.balance | truncateCurrency: currencyCode }}
            </mat-option>
          </mat-select>
          <mat-hint>Si sabes de qué cuenta salió el dinero, selecciónala aquí.</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Enlace al comprobante (opcional)</mat-label>
          <input
            matInput
            type="url"
            formControlName="receiptUrl"
            placeholder="https://drive.google.com/..."
          />
          <mat-hint>Puede ser un enlace a una foto o factura.</mat-hint>
          <mat-error *ngIf="requestForm.controls.receiptUrl.hasError('maxlength')">
            Máximo 500 caracteres.
          </mat-error>
        </mat-form-field>

        <div class="form-actions">
          <button mat-flat-button color="primary" type="submit" [disabled]="submitting() || requestForm.invalid">
            <mat-icon *ngIf="submitting()" class="spinner">autorenew</mat-icon>
            {{ submitting() ? 'Enviando...' : 'Enviar solicitud' }}
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</section>
